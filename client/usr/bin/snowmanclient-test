#!/usr/bin/python
import os
import sys
import xmlrpclib
import logging
import socket
import sqlalchemy
import ConfigParser

sys.path.append("/usr/share/snowman-client/")

try:
	from util.logger import initialize
	from util.config import Config
	from data.files import ConfigGenerator
	from data.models import Session, Rule
	initialize()
except ImportError:
	print "ERROR: Could not import the logging-facilities. Is Snowman-client installed?"
	sys.exit(1)
except IOError as e:
	print "ERROR: Could not get writing-access to the logging-location."
	print "\t", e
	print "\tIs '%s' ran as the correct user? Usually only snort or root is able to write to the logging-location." % sys.argv[0]
	sys.exit(1)
except ConfigParser.Error as e:
	print "ERROR: Could not parse the configurationfile."
	print "\t", e
	sys.exit(1)
except sqlalchemy.exc.SQLAlchemyError as e:
	print "ERROR: Could not connect to the supplied database."
	print "\t", e
	sys.exit(1)

ruleLocation = Config.get("configfiles", "location")
try:
	rf = open(os.path.join(ruleLocation, "snowmanClientTest.test"), "w")
	rf.write("TEST")
	rf.close()
	os.unlink(os.path.join(ruleLocation, "snowmanClientTest.test"))
except IOError as e:
	print "ERROR: Could not create a file in '%s'." % ruleLocation
	print "\t", e
	sys.exit(1)

try:
	from data.sync import SnowmanServer
	server = SnowmanServer()
	server.connect()
except SnowmanServer.ConnectionError as e:
	print "ERROR: Could not connect to the Snowman-server"
	print "\t", e
	sys.exit(1)


if(not server.connected):
	print "ERROR: Could not connect to the Snowman-server."
	print "\tHave a look into '%s' to see error-messages." % Config.get("logging", "logfile")
	sys.exit(1)

server.disconnect()


print "OK: The snowman-client is set up and configured correctly"


"""
def main():
	logger = logging.getLogger(__name__)
	
	generator = ConfigGenerator()
	s = Session.session()

	generator.cleanup()
	generator.generateConfigFile("classification.config", s.query(RuleClass).all(), lambda x: "config classification: %s,%s,%d" % (x.classtype, x.description, int(x.priority)))
	generator.generateConfigFile("gen-msg.map", s.query(Generator).order_by(Generator.gid).order_by(Generator.alertId).all(), lambda x: "%d || %d || %s" % (x.gid, x.alertId, x.message))
	generator.generateConfigFile("reference.config", s.query(RuleReferenceType).all(), lambda x: "config reference: %s %s" % (x.name, x.prefix))
	generator.generateRuleFiles()
	generator.generateConfigFile("suppress.config", s.query(Suppress).all(), lambda x: x.getConfigString())
	generator.generateConfigFile("eventfilters.config", s.query(EventFilter).all(), 
			lambda x: "event_filter gen_id 1, sig_id %d, type %s, track %s, count %d, seconds %s" % (x.rule.SID, EventFilter.TYPE[x.filtertype], EventFilter.TRACK[x.track], x.count, x.seconds))
	generator.generateIncludes()
	
if __name__ == "__main__":
	main()
"""
